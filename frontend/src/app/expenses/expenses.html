<div class="expenses-header">
  <h1>Despesas</h1>

  <button type="button" class="primary new-expense-btn" (click)="openForm()">
    + Nova despesa
  </button>
</div>

<div class="overlay" *ngIf="showForm">
  <div class="modal">
    <app-expense-form *ngIf="showForm" [expense]="selectedExpense" (saved)="closeForm(true)" (cancel)="closeForm()">
    </app-expense-form>
  </div>
</div>

<form [formGroup]="form" class="filters">
  <div class="field">
    <label>Data inicial</label>
    <input type="date" formControlName="startDate" />
  </div>

  <div class="field">
    <label>Data final</label>
    <input type="date" formControlName="endDate" />
  </div>

  <select formControlName="category">
    <option [ngValue]="null" disabled>Categoria</option>
    <option *ngFor="let cat of categories" [ngValue]="cat.id">
      {{ cat.name }}
    </option>
  </select>

  <select formControlName="card">
    <option [ngValue]="null" disabled>Cartão</option>
    <option *ngFor="let card of cards" [ngValue]="card.id">
      {{ card.bank_name }} - {{ card.brand }}
    </option>
  </select>

  <select formControlName="status">
    <option [ngValue]="null" disabled>Status</option>
    <option value="paid">Pago</option>
    <option value="pending">Pendente</option>
  </select>

  <div class="actions">
    <button type="button" class="primary" (click)="applyFilters()">
      Filtrar
    </button>
    <button type="button" class="outline" (click)="clearFilters()">
      Limpar
    </button>
  </div>
</form>

<div *ngIf="loadingList" class="loading">
  Carregando despesas...
</div>

<div *ngIf="!loadingList && expenses.length === 0" class="empty">
  Nenhuma despesa encontrada
</div>

<div class="expenses-list" *ngIf="!loadingList && expenses.length > 0">
  <div class="expense" *ngFor="let expense of expenses">

    <div class="info">
      <strong>{{ expense.description }}</strong>

      <small>{{ expense.purchase_date | date:'dd/MM/yyyy' }}</small>

      <small class="status" [class.paid]="expense.concluded" [class.pending]="!expense.concluded">
        {{ expense.concluded ? 'Pago' : 'Pendente' }}
      </small>

      <small *ngIf="expense.debito_automatico && expense.payment_type === 'CARTAO'" class="auto">
        Pago automaticamente
      </small>

      <small>
        {{ getPaymentLabel(expense) }}
      </small>

      <small *ngIf="expense.installments_quantity > 1">
        {{ expense.installments_quantity }}x de
        R$ {{ expense.installments_value | number:'1.2-2' }}
      </small>
    </div>

    <div class="meta">
      <span>
        R$ {{ expense.total_value | number:'1.2-2' }}
      </span>
      <small *ngIf="expense.installments_quantity > 1">
        {{ expense.remaining_installments }} parcelas restantes
      </small>
    </div>

    <div class="actions">
      <button class="pay-btn success" [disabled]="expense.concluded || loadingList"
        (click)="payNextInstallment(expense)">
        Marcar como pago
      </button>

      <button class="pay-btn outline-warning" *ngIf="expense.remaining_installments < expense.installments_quantity"
        (click)="undoPayment(expense)">
        Desfazer pagamento
      </button>

      <button class="icon" (click)="editExpense(expense)" aria-label="Editar">
        <i class="material-icons">edit</i>
      </button>

      <button class="icon danger" (click)="openDeleteConfirm(expense)" aria-label="Excluir">
        <i class="material-icons">delete</i>
      </button>
    </div>

  </div>
</div>
<div class="overlay" *ngIf="confirmDelete">
  <div class="modal confirm-modal">
    <h3>Confirmar exclusão</h3>

    <p>
      Deseja remover
      <strong>"{{ expenseToDelete?.description }}"</strong>?
    </p>

    <div class="actions">
      <button class="outline" (click)="cancelDelete()">
        Cancelar
      </button>

      <button class="danger" (click)="confirmDeleteExpense()">
        Remover
      </button>
    </div>
  </div>
</div>